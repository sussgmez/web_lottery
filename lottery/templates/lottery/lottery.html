{% extends 'core/base.html' %}
{% load static %}
{% load lottery_extras %}

{% block title %}
  {{ lottery.description }}
{% endblock %}

{% block content %}
  <section class="section-lottery">
    {% comment %}Lottery image{% endcomment %}
    <div class="lottery-image-tickets">
      <div class="lottery-image">
        <img src="{{ lottery.image.url }}" alt="" />
      </div>
      <div class="lottery-tickets">
        {% if not user.is_staff %}
          {% if user_tickets %}
            <h4>Mis tickets</h4>
            <div class="tickets">
              {% for ticket in user_tickets %}
                <div class="ticket">
                  <p>#{{ ticket.number }}</p>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="tickets-empty">Compra tus primeros tickets para participar.</p>
          {% endif %}
        {% endif %}
      </div>
      <div class="issues">
        <h4>¿Tienes algún inconveniente?</h4>
        <p>Ponte en contacto con nuestro equipo de soporte.</p>
        <div class="contact">
          <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M18.6038 12.7268L15.5652 9.08666C15.2572 8.69067 15.1032 8.49267 15.0225 8.27061C14.9511 8.07411 14.9215 7.86486 14.9357 7.65628C14.9518 7.42055 15.045 7.18766 15.2313 6.72187L15.942 4.94513C16.2177 4.25581 16.3556 3.91116 16.5934 3.68525C16.8029 3.48618 17.0656 3.3519 17.3496 3.29856C17.672 3.23803 18.0321 3.32806 18.7524 3.50812L20.7197 4.00002C20.7197 14 13.72 21 3.71973 21L3.2281 19.0324C3.04804 18.3122 2.95801 17.952 3.01854 17.6297C3.07188 17.3456 3.20616 17.083 3.40522 16.8734C3.63113 16.6356 3.97579 16.4977 4.66511 16.222L6.25064 15.5878C6.78204 15.3752 7.04773 15.2689 7.31264 15.2608C7.54678 15.2536 7.77934 15.3013 7.99171 15.4002C8.23199 15.512 8.43434 15.7144 8.83904 16.1191L11.9254 19.1569" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
          <p>+58 412 345 6789</p>
        </div>
        <div class="contact">
          <svg width="20px" height="20px" viewBox="0 -2.5 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>email [#1573]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-300.000000, -922.000000)" fill="#ffffff"> <g id="icons" transform="translate(56.000000, 160.000000)"> <path d="M262,764.291 L254,771.318 L246,764.281 L246,764 L262,764 L262,764.291 Z M246,775 L246,766.945 L254,773.98 L262,766.953 L262,775 L246,775 Z M244,777 L264,777 L264,762 L244,762 L244,777 Z" id="email-[#1573]"> </path> </g> </g> </g> </g></svg>
          <p>email@email.com</p>
        </div>
      </div>
    </div>
    {% comment %}Loterry info{% endcomment %}
    <div class="lottery-info">
      <h2>{{ lottery.description }}</h2>
      <div class="div-price">
        <p class="price">{{ lottery.price|floatformat:'.2f' }} $</p>
        <p class="ticket-1">x 1 ticket</p>
      </div>
      <div class="lottery-info-field">
        <p class="info-field-label">Fecha de cierre:</p>
        <p>{{ lottery.closing_date|date:'d/m/Y' }}</p>
      </div>
      <div class="lottery-info-field">
        <p class="info-field-label">Sorteo:</p>
        <p>Sorteo nacional</p>
      </div>
      {% comment %}if user is_authenticated{% endcomment %}
      {% if user.is_authenticated %}
        {% comment %}if user is_staff{% endcomment %}
        {% if user.is_staff %}
          <h3>Editar</h3>
          <form action="{% url 'lottery-update' lottery.pk %}" class="form-lottery-update" method="post" hx-get="{% url 'lottery-update' lottery.pk %}" hx-trigger="load" enctype="multipart/form-data"></form>
          <button class="button-admin-option" hx-get="{% url 'admin-order-list' lottery.pk %}?filter=" hx-target="#id_order_list" hx-on:click="htmx.removeClass('#id_modal_admin', 'hidden')">Ver pagos</button>
        {% else %}
          {% if lottery.closed %}
            <div class="lottery-closed">
              <p>Sorteo finalizado.</p>
            </div>
          {% else %}
            {% if available_tickets == 0 %}
              <p class="not-available">No quedan tickets disponibles</p>
            {% else %}
              <div id="id_div_order_create" class="div-order-create" hx-get="{% url 'order-create' %}?payment_method=0&lottery={{ lottery.pk }}" hx-trigger="load"></div>
            {% endif %}
          {% endif %}
        {% endif %}
      {% else %}
        <div class="no-login">
          <p>
            <a href="{% url 'login' %}">Inicia sesión</a> o <a href="{% url 'signup' %}">regístrate</a> para participar en los sorteos.
          </p>
        </div>
      {% endif %}
    </div>
  </section>
  {% if user.is_staff %}
    <div class="modal modal-admin hidden" id="id_modal_admin" hx-on:click="htmx.addClass(this, 'hidden')">
      <div class="admin-orders" onclick="event.stopPropagation()">
        <button class="btn-close" hx-on:click="htmx.addClass('#id_modal_admin', 'hidden')"><img src="{% static 'img/close.png' %}" alt="" /></button>
        <h4>Pagos</h4>
        <div class="order-list-filter">
          <input type="text" placeholder="Buscar..." hx-on:keyup="htmx.ajax('GET', `{% url 'admin-order-list' lottery.pk %}?filter=${this.value}`, '#id_order_list')"/>
        </div>
        <div class="order-list" id="id_order_list">
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script>
    function changePaymentMethod() {
      htmx.ajax('GET', `{% url 'order-create' %}?payment_method=${htmx.find('#id_payment_method').value}&lottery={{ object.pk }}`, '#id_div_order_create')
    }
    function amount(payment_method, quantity = 1) {
      if (payment_method == 0) {
        htmx.find('#id_amount_bs').value = (quantity * parseFloat('{{ lottery.price|floatformat:".2f" }}') * parseFloat('{{ dollar.exchange_rate }}')).toFixed(2)
      } else {
        htmx.find('#id_amount_usd').value = (quantity * parseFloat('{{ lottery.price|floatformat:".2f" }}')).toFixed(2)
      }
    }
    
    window.onload = () => {
      changePaymentMethod()
    }
  </script>
{% endblock %}
